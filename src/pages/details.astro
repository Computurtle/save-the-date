---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";

const qas = [
    {
        question: "What is the dress code?",
        answer: "The theme is Indian-inspired Western. For the ladies, Saris will be worn (we can help you find one!). For the men, suits or smart dress is perfect. We will also be providing some fun Indian accessories for everyone to wear on the day!",
    },
    {
        question: "What about the colors?",
        answer: "Our wedding palette is Lavender and Sage Green. You don't have to match this exactly, but it gives you an idea of the vibe we are going for.",
    },
    {
        question: "Is there a Henna night?",
        answer: "Yes! The bridal party will be doing Henna the day before (Oct 14th). If you're around and interested, let us know!",
    },
    {
        question: "Can I bring a plus one?",
        answer: "As we are keeping this very intimate (~15 guests), we are unfortunately unable to accommodate extra plus ones outside of those named on the invitation.",
    },
    {
        question: "What will the weather be like?",
        answer: "October in Margaret River is usually mild to cool (avg 16°C - 20°C). It can get chilly in the evenings, so bring a jacket!",
    },
];
---

<Layout>
    <Header />

    <div class="page-container">
        <h1 class="page-title">The Details</h1>

        <!-- Vibe & Theme Section -->
        <div class="vibe-card glass-card">
            <div class="vibe-content">
                <h2 class="card-title">The Vibe</h2>
                <p class="theme-text">
                    We are blending our worlds with an <strong
                        >Indian-inspired Western wedding</strong
                    >. Think rustic Margaret River charm meets vibrant Indian
                    tradition.
                </p>

                <div class="style-guide">
                    <div class="style-item">
                        <h3>Dress Code</h3>
                        <p><strong>Ladies:</strong> Saris</p>
                        <p><strong>Gents:</strong> Suits / Smart Dress</p>
                        <p class="note">
                            Indian accessories will be provided for everyone to
                            wear!
                        </p>
                    </div>

                    <div class="style-item">
                        <h3>Palette</h3>
                        <div class="color-swatches">
                            <div class="swatch lavender">
                                <span>Lavender</span>
                            </div>
                            <div class="swatch sage"><span>Sage</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Q&A Section -->
        <div class="qa-section">
            <h2 class="section-title">Questions & Answers</h2>
            <div class="qa-grid">
                {
                    qas.map((qa) => (
                        <div class="qa-card glass-card">
                            <h3>{qa.question}</h3>
                            <p>{qa.answer}</p>
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Song Requests Section -->
        <div class="glass-card form-card">
            <h2>Song Requests</h2>
            <p class="form-intro">
                Help us build the party playlist! If we like your suggestion,
                we'll add it to the queue.
            </p>

            <form
                id="song-form"
                name="song-requests"
                method="POST"
                data-netlify="true"
                netlify-honeypot="bot-field"
                class="song-form"
            >
                <p class="hidden" style="display: none;">
                    <label
                        >Don’t fill this out if you’re human: <input
                            name="bot-field"
                        /></label
                    >
                </p>

                <div class="form-group">
                    <label for="name">Your Name</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        placeholder="Who is this for?"
                    />
                </div>

                <div class="form-group">
                    <label for="song">Song Request</label>
                    <input
                        type="text"
                        id="song"
                        name="song"
                        required
                        placeholder="Song Title & Artist"
                    />
                </div>

                <div class="form-group">
                    <label for="security">Security Check</label>
                    <input
                        type="text"
                        id="security"
                        name="security"
                        required
                        placeholder="What year is the wedding?"
                    />
                </div>

                <button type="submit" class="submit-btn">Submit Request</button>
                <p id="form-status" class="form-status"></p>
            </form>
        </div>
    </div>
</Layout>

<script>
    const form = document.getElementById("song-form") as HTMLFormElement;
    const status = document.getElementById("form-status");
    const MAX_SUBMISSIONS = 20;
    const MIN_TIME_SECONDS = 2;
    const pageLoadTime = Date.now();

    // Check previous submissions
    const getSubmissionCount = () => {
        return parseInt(localStorage.getItem("song_form_submissions") || "0");
    };

    const incrementSubmissionCount = () => {
        const current = getSubmissionCount();
        localStorage.setItem("song_form_submissions", (current + 1).toString());
    };

    if (form && status) {
        // Disable if already over limit on load
        if (getSubmissionCount() >= MAX_SUBMISSIONS) {
            form.style.opacity = "0.5";
            form.style.pointerEvents = "none";
            status.textContent =
                "You have reached the maximum number of submissions.";
            status.classList.add("error");
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // 1. Session Rate Limit Check
            if (getSubmissionCount() >= MAX_SUBMISSIONS) {
                status.textContent =
                    "You have reached the maximum number of submissions.";
                status.classList.add("error");
                return;
            }

            // 2. Speed Trap (Bot Check)
            const timeElapsed = (Date.now() - pageLoadTime) / 1000;
            if (timeElapsed < MIN_TIME_SECONDS) {
                status.textContent =
                    "Please take your time filling out the form.";
                status.classList.add("error");
                return;
            }

            // 3. Security Question Check
            const securityInput = document.getElementById(
                "security",
            ) as HTMLInputElement;
            if (securityInput && securityInput.value.trim() !== "2026") {
                status.textContent =
                    "Incorrect security answer. Please try again.";
                status.classList.add("error");
                return;
            }

            const formData = new FormData(form);

            fetch("/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams(formData as any).toString(),
            })
                .then(() => {
                    incrementSubmissionCount(); // Count this success
                    status.textContent = "Received! Thank you.";
                    status.classList.add("success");
                    form.reset();

                    setTimeout(() => {
                        status.textContent = "";
                        status.classList.remove("success");
                    }, 5000);
                })
                .catch((error) => {
                    status.textContent = "Submission failed. Please try again.";
                    status.classList.add("error");
                });
        });
    }
</script>

<style>
    /* Vibe Card */
    .vibe-card {
        padding: var(--space-10);
        text-align: center;
        max-width: 900px;
        margin: 0 auto;
    }

    .theme-text {
        font-size: var(--font-size-lg);
        color: var(--color-text);
        margin-bottom: var(--space-10);
        line-height: 1.6;
    }

    .style-guide {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-8);
        text-align: left;
    }

    .style-item h3 {
        font-family: var(--font-heading);
        font-size: var(--font-size-2xl);
        color: var(--color-primary);
        margin-bottom: var(--space-4);
        border-bottom: 1px solid rgba(74, 74, 74, 0.2);
        padding-bottom: var(--space-2);
    }

    .style-item p {
        font-size: var(--font-size-lg);
        margin-bottom: var(--space-2);
        color: var(--color-text);
    }

    .note {
        font-size: var(--font-size-base) !important;
        font-style: italic;
        color: var(--color-text-light) !important;
        margin-top: var(--space-2);
    }

    /* Color Swatches */
    .color-swatches {
        display: flex;
        gap: var(--space-4);
    }

    .swatch {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-xs);
        font-weight: bold;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: var(--shadow-md);
    }

    .swatch.lavender {
        background-color: #b5a3d6; /* Lavender */
    }

    .swatch.sage {
        background-color: #9caf88; /* Sage Green */
    }

    /* Q&A Section */
    .section-title {
        font-family: var(--font-heading);
        font-size: var(--font-size-3xl);
        color: var(--color-primary);
        text-align: center;
        margin-bottom: var(--space-8);
    }

    .qa-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-6);
    }

    .qa-card {
        padding: var(--space-6);
        transition: transform 0.2s ease;
    }

    .qa-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.5);
    }

    .qa-card h3 {
        font-family: var(--font-heading);
        font-size: var(--font-size-xl);
        color: var(--color-secondary);
        margin-bottom: var(--space-3);
    }

    .qa-card p {
        color: var(--color-text);
        line-height: 1.5;
    }

    @media (max-width: 768px) {
        .style-guide {
            grid-template-columns: 1fr;
            text-align: center;
        }

        .style-item h3 {
            text-align: center;
        }

        .color-swatches {
            justify-content: center;
        }
    }

    /* Form Styles */
    .form-card {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
    }

    .form-card h2 {
        font-family: var(--font-heading);
        font-size: var(--font-size-3xl);
        color: var(--color-secondary);
        margin-bottom: var(--space-4);
        text-align: center;
    }

    .form-intro {
        text-align: center;
        margin-bottom: var(--space-6);
        color: var(--color-text);
    }

    .song-form {
        display: flex;
        flex-direction: column;
        gap: var(--space-6);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    label {
        font-weight: 500;
        color: var(--color-text);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    input[type="text"] {
        padding: var(--space-3);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.5);
        font-family: var(--font-body);
        font-size: var(--font-size-base);
        color: var(--color-text);
        transition: all 0.2s ease;
    }

    input[type="text"]:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.8);
        border-color: var(--color-primary);
    }

    .submit-btn {
        background: var(--color-primary);
        color: white;
        border: none;
        padding: var(--space-4);
        border-radius: var(--radius-full);
        font-family: var(--font-heading);
        font-size: var(--font-size-xl);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: var(--space-2);
    }

    .submit-btn:hover {
        background: #8a75c4;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .form-status {
        text-align: center;
        min-height: 1.5em;
        font-size: var(--font-size-sm);
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .form-status.success {
        color: var(--color-primary);
    }

    .form-status.error {
        color: #e53e3e;
    }
</style>
